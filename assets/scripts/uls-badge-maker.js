$(function(){function e(e){$.getJSON("assets/badges.json",function(r){b=r,void 0!==e&&e(),t(),a()}).fail(function(e,t){d(t,this.url)})}function t(){x=new fabric.Textbox("double click to edit text",{fontSize:28,fontWeight:"bold",textAlign:"center",showplaceholder:!0,opacity:.3}),p.add(x),x.set({fontFamily:"Montserrat",top:20,width:p.width,hasControls:!1,lockMovementX:!0,lockMovementY:!0}).setCoords().setFill(v.current),p.renderAll().bringToFront(x)}function a(){for(var e=b.ribbons,t=0;t<e.length;t++)$.get("assets/"+e[t].path+".svg",function(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("viewBox","0 0 500 130"),t.setAttribute("preserveAspectRatio","xMidYMid meet"),t.innerHTML=$(e).find("svg").html();var a=(new XMLSerializer).serializeToString(t);fabric.loadSVGFromString(a,function(e,t){w=fabric.util.groupSVGElements(e,t),p.add(w),w.scaleToWidth(.95*p.width).set({left:(p.width-w.getWidth())/2,top:p.height-w.getHeight()-30,selectable:!1}).setCoords(),k=new fabric.Textbox("double click to edit text",{fontSize:38,lineHeight:1,fontWeight:"bold",textAlign:"center",fill:"#fff",showplaceholder:!0,opacity:.3}),p.add(k),k.set({hasControls:!1,lockMovementX:!0,lockMovementY:!0,fontFamily:"Open Sans Condensed",width:400,height:80,left:(p.width-400)/2,top:p.height-w.getHeight()-26.5}).setCoords(),p.renderAll().bringToFront(w).bringToFront(k)})})}function r(){if(!1===h.loaded){for(var e=b.badges,t=0;t<e.length;t++){var a=document.createElement("div");a.classList.add("badge"),a.classList.add("badge_icon"),a.classList.add("bd"+t),$("#badges").append(a),o(e[t],"bd"+t)}$(".badge_icon").on("click",function(){$(".badge_icon").removeClass("selected"),$(this).addClass("selected"),n(this)}),h.loaded=!0}}function i(){if(!1===u.loaded){for(var e=b.backgrounds,t=0;t<e.length;t++){var a=document.createElement("div");a.classList.add("badge"),a.classList.add("badge_bg"),a.classList.add("bg"+t),$("#badge_bgs").append(a),o(e[t],"bg"+t)}$(".badge_bg").on("click",function(){$(".badge_bg").removeClass("selected"),$(this).addClass("selected"),s(this)}),u.loaded=!0}}function o(e,t){$.get("assets/"+e.path+".svg",function(a){var r=document.getElementsByClassName(t)[0],i=document.createElementNS("http://www.w3.org/2000/svg","svg"),o="";i.setAttribute("width","100%"),i.setAttribute("height","100%"),i.setAttribute("viewBox","0 0 500 500"),i.setAttribute("preserveAspectRatio","xMidYMid meet"),i.innerHTML=$(a).find("svg").html(),o=(new XMLSerializer).serializeToString(i),r.innerHTML=o,r.innerHTML+='<div class="name">'+e.name+"</div>"})}function n(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("viewBox","0 0 500 500"),t.setAttribute("preserveAspectRatio","xMidYMid meet"),t.innerHTML=$(e).children("svg").html();var a=(new XMLSerializer).serializeToString(t);null!==f&&p.remove(f),fabric.loadSVGFromString(a,function(e,t){f=fabric.util.groupSVGElements(e,t),p.add(f),f.scaleToHeight(.62*p.height).set({left:(p.width-f.getWidth())/2,top:38,centeredScaling:!0}).setCoords(),f.lockUniScaling=!0,f.lockRotation=!0,f.lockMovementX=!0,f.setControlVisible("mtr",!1);for(var a=0;a<f.paths.length;a++)"#FFFFFF"!==f.paths[a].fill&&f.paths[a].setFill(v.current);p.renderAll().bringToFront(f).bringToFront(x).bringToFront(w).bringToFront(k)})}function s(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("viewBox","0 0 500 500"),t.setAttribute("preserveAspectRatio","xMidYMid meet"),t.innerHTML=$(e).children("svg").html();var a=(new XMLSerializer).serializeToString(t);null!==m&&p.remove(m),fabric.loadSVGFromString(a,function(e,t){m=fabric.util.groupSVGElements(e,t),p.add(m),m.scaleToHeight(.85*p.height).set({left:(p.width-m.getWidth())/2,top:p.height-m.getHeight()-10,selectable:!1}).setCoords().setFill(v.current),p.renderAll().sendToBack(m)})}function d(e,t){t=void 0!==t?t:"";var a="";switch(e){case"parsererror":a="Invalid JSON in "+t;break;default:a="Error loading "+t+". Make sure the file exists.";break}console.error(a)}function l(){if($(document).width()<1025){var e=g.canvasWrapper.outerHeight();g.tabContainer.css("height","calc(100% - "+e+"px)")}else g.tabContainer.css("height","");p.setWidth(g.hiddenShaper.width()),p.setHeight(g.hiddenShaper.height())}function c(e){for(var t=e.split(","),a=t[0].match(/:(.*?);/)[1],r=atob(t[1]),i=r.length,o=new Uint8Array(i);i--;)o[i]=r.charCodeAt(i);return new Blob([o],{type:a})}var g={wrapper:$("#uls-badge-maker"),header:$("#uls-badge-maker header"),canvasWrapper:$("#uls-badge-maker .badge-body .canvas-wrapper"),hiddenShaper:$("#uls-badge-maker .badge-body .canvas-wrapper .hidden-shaper"),tabContainer:$("#uls-badge-maker .badge-body .badge-container"),tabControl:$("#uls-badge-maker .badge-body .badge-container .tab-control"),tabItem:$("#uls-badge-maker .badge-body .badge-container .tab-control .tab-item"),activeTabItem:$("#uls-badge-maker .badge-body .badge-container .tab-control .tab-item.active"),tabContent:$("#uls-badge-maker .badge-body .badge-container .tab-content"),ctaWrapper:$("#uls-badge-maker .badge-body .cta"),colorBoxes:$("#uls-badge-maker .badge-body .badge-container .box"),exportBtn:$("#uls-badge-maker .badge-body .cta #exportBtn"),previewBtn:$("#uls-badge-maker .badge-body .cta #previewBtn"),titleTxtBox:$("#uls-badge-maker .badge-body .canvas-wrapper .title_text_field input"),ribbonTxtBox:$("#uls-badge-maker .badge-body .canvas-wrapper .ribbon_text_field textarea"),footer:$("#uls-badge-maker footer")},b={},h={loaded:!1},u={loaded:!1},v={loaded:!1,current:"#000"},p=new fabric.Canvas("badge-preview",{preserveObjectStacking:!0,backgroundColor:"#fff"}),f=null,m=null,w=null,x=null,k=null;l(),$(window).on("resize",l),e(r),g.previewBtn.on("click",function(){p.isDrawingMode=!1;var e=p.toDataURL({format:"png"}),t=c(e),a=URL.createObjectURL(t);window.open(a)}),g.exportBtn.on("click",function(){p.isDrawingMode=!1;var e=new Date,t=document.createElement("a"),a=p.toDataURL({format:"png"}),r=c(a),i=URL.createObjectURL(r);t.download="uls_badge_"+e.getTime()+".png",t.href=i;var o=new MouseEvent("click",{view:window,bubble:!0,cancelable:!1});t.dispatchEvent(o)}),g.tabItem.on("click",function(e){var t=$(e.currentTarget);if(!t.hasClass("active")){var a=t.data("target");switch(g.tabItem.removeClass("active"),t.addClass("active"),g.tabContent.removeClass("active"),$("#"+a).addClass("active"),a){case"badges":r();break;case"badge_bgs":i();break;case"colors":v.loaded||(g.colorBoxes.each(function(){var e=$(this).find("span").data("hex");$(this).css("background",e)}),g.colorBoxes.on("click",function(){var e=$(this).find("span").data("hex");if(g.colorBoxes.removeClass("selected"),$(this).addClass("selected"),f)for(var t=0;t<f.paths.length;t++)"#FFFFFF"!==f.paths[t].fill&&f.paths[t].setFill(e);m&&m.setFill(e),x&&x.setFill(e),p.renderAll(),v.current=e}),v.loaded=!0);break}}}),p.on("text:changed",function(e){var t=e.target;""===t.getText()?(t.setText("double click to edit text"),t.set("opacity",.3),t.set("showplaceholder",!0),t.setCoords(),p.renderAll()):!0===t.get("showplaceholder")&&"double click to edit text"!==e.target.text&&(t.setText(t.getText().substr(0,1)),t._updateTextarea(),t.set("opacity",1),t.set("showplaceholder",!1),t.setCoords(),p.renderAll())}),p.on("text:editing:entered",function(e){var t=e.target;!0===t.get("showplaceholder")&&(t.setSelectionStart(0),t.setSelectionEnd(0),"Montserrat"!==t.getFontFamily()&&t.set({top:p.height-w.getHeight()-26.5}).setCoords(),p.renderAll())}),p.on("text:editing:exited",function(e){var t=e.target;if(!0!==t.get("showplaceholder")){var a=t.getText();t.setText(a.toUpperCase()),"Montserrat"!==t.getFontFamily()&&(t.height<=42.94?t.set({top:p.height-w.getHeight()-5}).setCoords():t.set({top:p.height-w.getHeight()-26.5}).setCoords(),p.renderAll())}})});