$(function(){function e(e){$.getJSON("assets/badges.json",function(r){g=r,void 0!==e&&e(),t(),a()}).fail(function(e,t){d(t,this.url)})}function t(){w=new fabric.Textbox("double click to edit text",{fontSize:28,fontWeight:"bold",textAlign:"center",showplaceholder:!0,opacity:.3}),p.add(w),w.set({fontFamily:"Montserrat",top:32,width:p.width,hasControls:!1,lockMovementX:!0,lockMovementY:!0}).setCoords().setFill(u.current),p.renderAll().bringToFront(w)}function a(){for(var e=g.ribbons,t=0;t<e.length;t++)$.get("assets/"+e[t].path+".svg",function(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("viewBox","0 0 500 130"),t.setAttribute("preserveAspectRatio","xMidYMid meet"),t.innerHTML=$(e).find("svg").html();var a=(new XMLSerializer).serializeToString(t);fabric.loadSVGFromString(a,function(e,t){m=fabric.util.groupSVGElements(e,t),p.add(m),m.scaleToWidth(.95*p.width).set({left:(p.width-m.getWidth())/2,top:p.height-m.getHeight()-30,selectable:!1}).setCoords(),x=new fabric.Textbox("double click to edit text",{fontSize:38,lineHeight:1,fontWeight:"bold",textAlign:"center",fill:"#fff",showplaceholder:!0,opacity:.3}),p.add(x),x.set({hasControls:!1,lockMovementX:!0,lockMovementY:!0,fontFamily:"Open Sans Condensed",width:400,height:80,left:(p.width-400)/2,top:p.height-m.getHeight()-26.5}).setCoords(),p.renderAll().bringToFront(m).bringToFront(x)})})}function r(){if(!1===b.loaded){for(var e=g.badges,t=0;t<e.length;t++){var a=document.createElement("div");a.classList.add("badge"),a.classList.add("badge_icon"),a.classList.add("bd"+t),$("#badges").append(a),o(e[t],"bd"+t)}$(".badge_icon").on("click",function(){$(".badge_icon").removeClass("selected"),$(this).addClass("selected"),n(this)}),b.loaded=!0}}function i(){if(!1===h.loaded){for(var e=g.backgrounds,t=0;t<e.length;t++){var a=document.createElement("div");a.classList.add("badge"),a.classList.add("badge_bg"),a.classList.add("bg"+t),$("#badge_bgs").append(a),o(e[t],"bg"+t)}$(".badge_bg").on("click",function(){$(".badge_bg").removeClass("selected"),$(this).addClass("selected"),s(this)}),h.loaded=!0}}function o(e,t){$.get("assets/"+e.path+".svg",function(a){var r=document.getElementsByClassName(t)[0],i=document.createElementNS("http://www.w3.org/2000/svg","svg"),o="";i.setAttribute("width","100%"),i.setAttribute("height","100%"),i.setAttribute("viewBox","0 0 500 500"),i.setAttribute("preserveAspectRatio","xMidYMid meet"),i.innerHTML=$(a).find("svg").html(),o=(new XMLSerializer).serializeToString(i),r.innerHTML=o,r.innerHTML+='<div class="name">'+e.name+"</div>"})}function n(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("viewBox","0 0 500 500"),t.setAttribute("preserveAspectRatio","xMidYMid meet"),t.innerHTML=$(e).children("svg").html();var a=(new XMLSerializer).serializeToString(t);null!==v&&p.remove(v),fabric.loadSVGFromString(a,function(e,t){v=fabric.util.groupSVGElements(e,t),p.add(v),v.scaleToHeight(.62*p.height).set({left:(p.width-v.getWidth())/2,top:38}).setCoords(),v.lockUniScaling=!0;for(var a=0;a<v.paths.length;a++)"#FFFFFF"!==v.paths[a].fill&&v.paths[a].setFill(u.current);p.renderAll().bringToFront(v).bringToFront(w).bringToFront(m).bringToFront(x)})}function s(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("viewBox","0 0 500 500"),t.setAttribute("preserveAspectRatio","xMidYMid meet"),t.innerHTML=$(e).children("svg").html();var a=(new XMLSerializer).serializeToString(t);null!==f&&p.remove(f),fabric.loadSVGFromString(a,function(e,t){f=fabric.util.groupSVGElements(e,t),p.add(f),f.scaleToHeight(.85*p.height).set({left:(p.width-f.getWidth())/2,top:p.height-f.getHeight()-10,selectable:!1}).setCoords().setFill(u.current),p.renderAll().sendToBack(f)})}function d(e,t){t=void 0!==t?t:"";var a="";switch(e){case"parsererror":a="Invalid JSON in "+t;break;default:a="Error loading "+t+". Make sure the file exists.";break}console.error(a)}function l(){if($(document).width()<1025){var e=c.canvasWrapper.outerHeight();c.tabContainer.css("height","calc(100% - "+e+"px)")}else c.tabContainer.css("height","");p.setWidth(c.hiddenShaper.width()),p.setHeight(c.hiddenShaper.height())}var c={wrapper:$("#uls-badge-maker"),header:$("#uls-badge-maker header"),canvasWrapper:$("#uls-badge-maker .badge-body .canvas-wrapper"),hiddenShaper:$("#uls-badge-maker .badge-body .canvas-wrapper .hidden-shaper"),tabContainer:$("#uls-badge-maker .badge-body .badge-container"),tabControl:$("#uls-badge-maker .badge-body .badge-container .tab-control"),tabItem:$("#uls-badge-maker .badge-body .badge-container .tab-control .tab-item"),activeTabItem:$("#uls-badge-maker .badge-body .badge-container .tab-control .tab-item.active"),tabContent:$("#uls-badge-maker .badge-body .badge-container .tab-content"),ctaWrapper:$("#uls-badge-maker .badge-body .cta"),colorBoxes:$("#uls-badge-maker .badge-body .badge-container .box"),exportBtn:$("#uls-badge-maker .badge-body .cta #exportBtn"),titleTxtBox:$("#uls-badge-maker .badge-body .canvas-wrapper .title_text_field input"),ribbonTxtBox:$("#uls-badge-maker .badge-body .canvas-wrapper .ribbon_text_field textarea"),footer:$("#uls-badge-maker footer")},g={},b={loaded:!1},h={loaded:!1},u={loaded:!1,current:"#000"},p=new fabric.Canvas("badge-preview",{preserveObjectStacking:!0,backgroundColor:"#fff"}),v=null,f=null,m=null,w=null,x=null;l(),$(window).on("resize",l),e(r),c.exportBtn.on("click",function(){p.isDrawingMode=!1,window.open(p.toDataURL("png"))}),c.tabItem.on("click",function(e){var t=$(e.currentTarget);if(!t.hasClass("active")){var a=t.data("target");switch(c.tabItem.removeClass("active"),t.addClass("active"),c.tabContent.removeClass("active"),$("#"+a).addClass("active"),a){case"badges":r();break;case"badge_bgs":i();break;case"colors":u.loaded||(c.colorBoxes.each(function(){var e=$(this).find("span").data("hex");$(this).css("background",e)}),c.colorBoxes.on("click",function(){var e=$(this).find("span").data("hex");if(c.colorBoxes.removeClass("selected"),$(this).addClass("selected"),v)for(var t=0;t<v.paths.length;t++)"#FFFFFF"!==v.paths[t].fill&&v.paths[t].setFill(e);f&&f.setFill(e),w&&w.setFill(e),p.renderAll(),u.current=e}),u.loaded=!0);break}}}),p.on("text:changed",function(e){var t=e.target;""===t.getText()?(t.setText("double click to edit text"),t.set("opacity",.3),t.set("showplaceholder",!0),t.setCoords(),p.renderAll()):!0===t.get("showplaceholder")&&"double click to edit text"!==e.target.text&&(t.setText(t.getText().substr(0,1)),t._updateTextarea(),t.set("opacity",1),t.set("showplaceholder",!1),t.setCoords(),p.renderAll())}),p.on("text:editing:entered",function(e){var t=e.target;!0===t.get("showplaceholder")&&(t.setSelectionStart(0),t.setSelectionEnd(0),p.renderAll()),"Montserrat"!==t.getFontFamily()&&(t.set({top:p.height-m.getHeight()-26.5}).setCoords(),p.renderAll())}),p.on("text:editing:exited",function(e){var t=e.target;if(!0!==t.get("showplaceholder")){var a=t.getText();t.setText(a.toUpperCase()),"Montserrat"!==t.getFontFamily()&&(t.height<=42.94?(t.set({top:p.height-m.getHeight()-5}).setCoords(),p.renderAll()):(t.set({top:p.height-m.getHeight()-26.5}).setCoords(),p.renderAll()))}})});