$(function(){function e(e){$.getJSON("assets/badges.json",function(t){p=t,void 0!==e&&e(),r(),n()}).fail(function(e,t){h(t,this.url)})}function t(e){!1===w.loaded&&$.getJSON("assets/badges/icomoon/selection.json",function(t){var i=[];for(var a in t.icons)0===t.icons[a].setIdx&&i.push(t.icons[a]);m=i,void 0!==e&&e(),w.loaded=!0}).fail(function(e,t){h(t,this.url)})}function i(){for(var e=m,t=0;t<e.length;t++)if(0===e[t].setIdx){var i=e[t].iconIdx+1,r=o(i,4)+"-"+e[t].properties.name,n=document.createElement("div");n.classList.add("badge"),n.classList.add("ico_icon"),n.classList.add("ico"+t),$("#icomoon").append(n),t>=e.length-1&&$("#icomoon .loading").fadeOut(1e3),a(r,"ico"+t)}$(".ico_icon").on("click",function(){$(".ico_icon").removeClass("selected"),$(this).addClass("selected"),g(this)})}function a(e,t){$.get("assets/badges/icomoon/"+e+".svg",function(i){var a=document.getElementsByClassName(t)[0],o=document.createElementNS("http://www.w3.org/2000/svg","svg"),r="",n=e.substring(5,e.length);o.setAttribute("width","100%"),o.setAttribute("height","100%"),o.setAttribute("viewBox","0 0 64 64"),o.setAttribute("preserveAspectRatio","xMidYMid meet"),o.innerHTML=$(i).find("svg").html(),r=(new XMLSerializer).serializeToString(o),a.innerHTML=r,a.innerHTML+='<div class="name">'+n+"</div>"})}function o(e,t,i){return Array(t-String(e).length+1).join(i||"0")+e}function r(){M=new fabric.Textbox("double click to edit text",{fontSize:28,fontWeight:"bold",textAlign:"center",showplaceholder:!0,opacity:.3}),A.add(M),M.set({fontFamily:"Montserrat",top:20,width:A.width,hasControls:!1,lockMovementX:!0,lockMovementY:!0}).setCoords().setFill(S.current),A.renderAll().bringToFront(M)}function n(){for(var e=p.ribbons,t=0;t<e.length;t++)$.get("assets/"+e[t].path+".svg",function(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("viewBox","0 0 500 130"),t.setAttribute("preserveAspectRatio","xMidYMid meet"),t.innerHTML=$(e).find("svg").html();var i=(new XMLSerializer).serializeToString(t);fabric.loadSVGFromString(i,function(e,t){C=fabric.util.groupSVGElements(e,t),A.add(C),C.scaleToWidth(.95*A.width).set({left:(A.width-C.getWidth())/2,top:A.height-C.getHeight()-30,selectable:!1}).setCoords(),L=new fabric.Textbox("double click to edit text",{fontSize:38,lineHeight:1,fontWeight:"bold",textAlign:"center",fill:"#fff",showplaceholder:!0,opacity:.3}),A.add(L),L.set({hasControls:!1,lockMovementX:!0,lockMovementY:!0,fontFamily:"Open Sans Condensed",width:400,height:80,left:(A.width-400)/2,top:A.height-C.getHeight()-26.5}).setCoords(),A.renderAll().bringToFront(C).bringToFront(L)})})}function s(){if(!1===x.loaded){for(var e=p.badges,t=0;t<e.length;t++){var i=document.createElement("div");i.classList.add("badge"),i.classList.add("badge_icon"),i.classList.add("bd"+t),$("#badges").append(i),l(e[t],"bd"+t)}$(".badge_icon").on("click",function(){$(".badge_icon").removeClass("selected"),$(this).addClass("selected"),c(this)}),x.loaded=!0}}function d(){if(!1===k.loaded){for(var e=p.backgrounds,t=0;t<e.length;t++){var i=document.createElement("div");i.classList.add("badge"),i.classList.add("badge_bg"),i.classList.add("bg"+t),$("#badge_bgs").append(i),l(e[t],"bg"+t)}$(".badge_bg").on("click",function(){$(".badge_bg").removeClass("selected"),$(this).addClass("selected"),b(this)}),k.loaded=!0}}function l(e,t){$.get("assets/"+e.path+".svg",function(i){var a=document.getElementsByClassName(t)[0],o=document.createElementNS("http://www.w3.org/2000/svg","svg"),r="";o.setAttribute("width","100%"),o.setAttribute("height","100%"),o.setAttribute("viewBox","0 0 500 500"),o.setAttribute("preserveAspectRatio","xMidYMid meet"),o.innerHTML=$(i).find("svg").html(),r=(new XMLSerializer).serializeToString(o),a.innerHTML=r,a.innerHTML+='<div class="name">'+e.name+"</div>"})}function c(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("viewBox","0 0 500 500"),t.setAttribute("preserveAspectRatio","xMidYMid meet"),t.innerHTML=$(e).children("svg").html();var i=(new XMLSerializer).serializeToString(t);null!==F&&A.remove(F),fabric.loadSVGFromString(i,function(e,t){F=fabric.util.groupSVGElements(e,t),A.add(F),F.scaleToHeight(.62*A.height).set({left:(A.width-F.getWidth())/2,top:38,centeredScaling:!0}).setCoords(),F.lockUniScaling=!0,F.lockRotation=!0,F.lockMovementX=!0,F.setControlVisible("mtr",!1);for(var i=0;i<F.paths.length;i++)"#FFFFFF"!==F.paths[i].fill&&F.paths[i].setFill(S.current);A.renderAll().bringToFront(F).bringToFront(M).bringToFront(C).bringToFront(L)})}function g(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("viewBox","0 0 64 64"),t.setAttribute("preserveAspectRatio","xMidYMid meet"),t.innerHTML=$(e).children("svg").html();var i=(new XMLSerializer).serializeToString(t);null!==F&&A.remove(F),fabric.loadSVGFromString(i,function(e,t){F=fabric.util.groupSVGElements(e,t),A.add(F),F.scaleToHeight(.62*A.height).set({left:(A.width-F.getWidth())/2,top:38,centeredScaling:!0,strokeWidth:5,stroke:"#fff"}).setCoords(),F.lockUniScaling=!0,F.lockRotation=!0,F.lockMovementX=!0,F.setControlVisible("mtr",!1);for(var i=0;i<F.paths.length;i++)"#FFFFFF"!==F.paths[i].fill&&F.paths[i].setFill(S.current);A.renderAll().bringToFront(F).bringToFront(M).bringToFront(C).bringToFront(L)})}function b(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("viewBox","0 0 500 500"),t.setAttribute("preserveAspectRatio","xMidYMid meet"),t.innerHTML=$(e).children("svg").html();var i=(new XMLSerializer).serializeToString(t);null!==T&&A.remove(T),fabric.loadSVGFromString(i,function(e,t){T=fabric.util.groupSVGElements(e,t),A.add(T),T.scaleToHeight(.85*A.height).set({left:(A.width-T.getWidth())/2,top:A.height-T.getHeight()-10,selectable:!1}).setCoords().setFill(S.current),A.renderAll().sendToBack(T)})}function h(e,t){t=void 0!==t?t:"";var i="";switch(e){case"parsererror":i="Invalid JSON in "+t;break;default:i="Error loading "+t+". Make sure the file exists.";break}console.error(i)}function u(){if($(document).width()<1025){var e=f.canvasWrapper.outerHeight();f.tabContainer.css("height","calc(100% - "+e+"px)")}else f.tabContainer.css("height","");A.setWidth(f.hiddenShaper.width()),A.setHeight(f.hiddenShaper.height())}function v(e){for(var t=e.split(","),i=t[0].match(/:(.*?);/)[1],a=atob(t[1]),o=a.length,r=new Uint8Array(o);o--;)r[o]=a.charCodeAt(o);return new Blob([r],{type:i})}var f={wrapper:$("#uls-badge-maker"),header:$("#uls-badge-maker header"),canvasWrapper:$("#uls-badge-maker .badge-body .canvas-wrapper"),hiddenShaper:$("#uls-badge-maker .badge-body .canvas-wrapper .hidden-shaper"),tabContainer:$("#uls-badge-maker .badge-body .badge-container"),tabControl:$("#uls-badge-maker .badge-body .badge-container .tab-control"),tabItem:$("#uls-badge-maker .badge-body .badge-container .tab-control .tab-item"),activeTabItem:$("#uls-badge-maker .badge-body .badge-container .tab-control .tab-item.active"),tabContent:$("#uls-badge-maker .badge-body .badge-container .tab-content"),ctaWrapper:$("#uls-badge-maker .badge-body .cta"),colorBoxes:$("#uls-badge-maker .badge-body .badge-container .box"),exportBtn:$("#uls-badge-maker .badge-body .cta #exportBtn"),previewBtn:$("#uls-badge-maker .badge-body .cta #previewBtn"),titleTxtBox:$("#uls-badge-maker .badge-body .canvas-wrapper .title_text_field input"),ribbonTxtBox:$("#uls-badge-maker .badge-body .canvas-wrapper .ribbon_text_field textarea"),footer:$("#uls-badge-maker footer")},p={},m={},w={loaded:!1},x={loaded:!1},k={loaded:!1},S={loaded:!1,current:"#000"},A=new fabric.Canvas("badge-preview",{preserveObjectStacking:!0,backgroundColor:"#fff"}),F=null,T=null,C=null,M=null,L=null;u(),$(window).on("resize",u),e(s),f.previewBtn.on("click",function(){A.isDrawingMode=!1,window.open(A.toDataURL({format:"png"}))}),f.exportBtn.on("click",function(){A.isDrawingMode=!1;var e=new Date,t=document.createElement("a"),i=A.toDataURL({format:"png"}),a=v(i),o=URL.createObjectURL(a);t.download="uls_badge_"+e.getTime()+".png",t.href=o;var r=new MouseEvent("click",{view:window,bubble:!0,cancelable:!1});t.dispatchEvent(r)}),f.tabItem.on("click",function(e){var a=$(e.currentTarget);if(!a.hasClass("active")){var o=a.data("target");switch(f.tabItem.removeClass("active"),a.addClass("active"),f.tabContent.removeClass("active"),$("#"+o).addClass("active"),o){case"badges":s();break;case"badge_bgs":d();break;case"icomoon":t(i);break;case"colors":S.loaded||(f.colorBoxes.each(function(){var e=$(this).find("span").data("hex");$(this).css("background",e)}),f.colorBoxes.on("click",function(){var e=$(this).find("span").data("hex");if(f.colorBoxes.removeClass("selected"),$(this).addClass("selected"),F)for(var t=0;t<F.paths.length;t++)"#FFFFFF"!==F.paths[t].fill&&F.paths[t].setFill(e);T&&T.setFill(e),M&&M.setFill(e),A.renderAll(),S.current=e}),S.loaded=!0);break}}}),A.on("text:changed",function(e){var t=e.target;""===t.getText()?(t.setText("double click to edit text"),t.set("opacity",.3),t.set("showplaceholder",!0),t.setCoords(),A.renderAll()):!0===t.get("showplaceholder")&&"double click to edit text"!==e.target.text&&(t.setText(t.getText().substr(0,1)),t._updateTextarea(),t.set("opacity",1),t.set("showplaceholder",!1),t.setCoords(),A.renderAll())}),A.on("text:editing:entered",function(e){var t=e.target;!0===t.get("showplaceholder")&&(t.setSelectionStart(0),t.setSelectionEnd(0),A.renderAll()),"Montserrat"!==t.getFontFamily()&&(t.set({top:A.height-C.getHeight()-26.5}).setCoords(),A.renderAll())}),A.on("text:editing:exited",function(e){var t=e.target;if(!0!==t.get("showplaceholder")){var i=t.getText();t.setText(i.toUpperCase()),"Montserrat"!==t.getFontFamily()&&(t.height<=42.94?(t.set({top:A.height-C.getHeight()-5}).setCoords(),A.renderAll()):(t.set({top:A.height-C.getHeight()-26.5}).setCoords(),A.renderAll()))}})});